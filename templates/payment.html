{% extends "base.html" %}
{% block title %}Pay with KHQR{% endblock %}
{% block content %}
<style>
  .khqr-card { max-width:430px;margin:0 auto;background:#fff;border:1px solid #ddd;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.06); }
  .khqr-header { background:#D3222A;color:#fff;padding:14px 16px;font-weight:800;letter-spacing:.5px; }
  .khqr-body { padding:20px; }
  .khqr-name { text-align:center;font-weight:700;color:#333;margin-top:6px; }
  .khqr-amount { text-align:center;font-size:44px;line-height:1.1;margin:8px 0 0; word-break:break-word; }
  .khqr-cur { text-align:center;color:#666;margin-top:2px;font-weight:600; }
  .khqr-time { text-align:center;color:#8aa;margin:6px 0 10px; }
  hr { border:none;border-top:1px dashed #e3e6ea;margin:10px 0 14px; }
  .khqr-qwrap { display:flex;justify-content:center;margin:8px 0 16px; }
  .khqr-qr { width:280px;height:280px;background:#fff; }
  .khqr-qr.dim { opacity:.35; filter:grayscale(100%); }
  .khqr-subtle { text-align:center;color:#97a1a9;font-size:12px;margin-bottom:12px; }
  .actions { display:flex;gap:10px;padding:0 20px 20px; flex-wrap:wrap; }
  .btn { flex:1;padding:10px 14px;border-radius:8px;border:1px solid #ddd;cursor:pointer;background:#fff; text-align:center; }
  .btn.primary { background:#111;color:#fff;border-color:#111; }
  .btn[disabled] { opacity:.6; cursor:not-allowed; }
</style>

<div class="khqr-card">
  <div class="khqr-header">KHQR</div>
  <div class="khqr-body">
    <div class="khqr-name">{{ name }}</div>
    <div class="khqr-amount">{{ amount }}</div>
    <div class="khqr-cur">{{ currency }}</div>
    <div class="khqr-time" id="timer" aria-live="polite"></div>
    <hr />

    <div class="khqr-qwrap" id="qr-section">
     <img class="khqr-qr"
     src="{{ url_for('qr_png', md5=md5) }}"
     alt="KHQR Code"
     loading="lazy" decoding="async" />
    </div>
    <div class="khqr-subtle">Scan with your banking app to pay.</div>

    <div id="payment-status" style="font-weight:600; margin:10px 0;" aria-live="polite">
      Waiting for payment...
    </div>
  </div>
  <div class="actions">
    <button id="paid" class="btn primary">I've Paid</button>
    <a class="btn" href="{{ url_for('products') }}">Continue Shopping</a>
    <a class="btn" id="regen" href="{{ url_for('checkout') }}" style="display:none;">Get new QR</a>
  </div>
</div>

<script>
  // ---------- Countdown ----------
  let seconds = {{ seconds|int }};
  const timerEl = document.getElementById('timer');
  const statusEl = document.getElementById('payment-status');
  const qrSection = document.getElementById('qr-section');
  const qrImg = document.getElementById('qr-image');
  const btnPaid = document.getElementById('paid');
  const btnRegen = document.getElementById('regen');

  // ---------- Polling (single loop, cookie included) ----------
  const md5 = "{{ md5 }}";
  const CHECK_URL = "{{ url_for('check_payment') }}";
  const POLL_MS = 3000; // 3s is reasonable, avoid hammering server

  let stop = false;
  let inFlight = false;
  let pollTimer = null;

  function markExpiredUI() {
    stop = true; // ⛔ stop further polls
    if (btnPaid) { btnPaid.disabled = true; }
    if (btnRegen) { btnRegen.style.display = 'inline-block'; }
    if (qrImg) { qrImg.classList.add('dim'); }
  }

  function markSuccess() {
    stop = true;
    if (pollTimer) clearTimeout(pollTimer);
    if (qrSection) qrSection.style.display = 'none';
    statusEl.style.color = 'green';
    statusEl.style.fontSize = '1.1rem';
    statusEl.textContent = '✅ Payment Success';
    if (btnPaid) { btnPaid.disabled = true; btnPaid.style.opacity = .6; }
    setTimeout(() => { window.location = "{{ url_for('checkout_success') }}"; }, 900);
  }

  async function pollOnce() {
    if (stop || inFlight) return;
    inFlight = true;
    try {
      const res = await fetch(CHECK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ md5 }),
        credentials: "same-origin"
      });

      // If server enforces expiry, it may send 410 Gone
      if (res.status === 410) {
        statusEl.textContent = "QR expired. Please get a new QR.";
        statusEl.style.color = "#b00";
        markExpiredUI();
        return;
      }

      const data = await res.json().catch(() => ({}));

      if (typeof data.message === 'string' && data.message) {
        statusEl.textContent = data.message;
      }

      if (data && data.success === true) {
        markSuccess();
        return;
      }
    } catch (e) {
      // network hiccup: keep polling later
    } finally {
      inFlight = false;
      if (!stop) pollTimer = setTimeout(pollOnce, POLL_MS);
    }
  }

  (function tick(){
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    timerEl.textContent = m + ":" + s;
    if (seconds > 0) {
      seconds--; setTimeout(tick, 1000);
    } else {
      statusEl.textContent = "QR expired. Please get a new QR.";
      statusEl.style.color = "#b00";
      markExpiredUI(); // ← stop polling on client when timer ends
    }
  })();

  // Start
  pollOnce();
  if (btnPaid) btnPaid.addEventListener('click', () => { pollOnce(); });
</script>
{% endblock %}
