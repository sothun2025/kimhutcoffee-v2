{% extends "base.html" %}
{% block title %}Pay with KHQR{% endblock %}
{% block content %}
<style>
  .khqr-card { max-width:430px;margin:0 auto;background:#fff;border:1px solid #ddd;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.06); }
  .khqr-header { background:#D3222A;color:#fff;padding:14px 16px;font-weight:800;letter-spacing:.5px; }
  .khqr-body { padding:20px; }
  .khqr-name { text-align:center;font-weight:700;color:#333;margin-top:6px; }
  .khqr-amount { text-align:center;font-size:44px;line-height:1.1;margin:8px 0 0; }
  .khqr-cur { text-align:center;color:#666;margin-top:2px;font-weight:600; }
  .khqr-time { text-align:center;color:#8aa;margin:6px 0 10px; }
  hr { border:none;border-top:1px dashed #e3e6ea;margin:10px 0 14px; }
  .khqr-qwrap { display:flex;justify-content:center;margin:8px 0 16px; }
  .khqr-qr { width:280px;height:280px;background:#fff; }
  .khqr-subtle { text-align:center;color:#97a1a9;font-size:12px;margin-bottom:12px; }
  .actions { display:flex;gap:10px;padding:0 20px 20px; }
  .btn { flex:1;padding:10px 14px;border-radius:8px;border:1px solid #ddd;cursor:pointer;background:#fff; }
  .btn.primary { background:#111;color:#fff;border-color:#111; }
</style>

<div class="khqr-card">
  <div class="khqr-header">KHQR</div>
  <div class="khqr-body">
    <div class="khqr-name">{{ name }}</div>
    <div class="khqr-amount">{{ amount }}</div>
    <div class="khqr-cur">{{ currency }}</div>
    <div class="khqr-time" id="timer"></div>
    <hr />

    <!-- Put the id on the ACTUAL QR container so we can hide it -->
    <div class="khqr-qwrap" id="qr-section">
      <img class="khqr-qr" src="{{ url_for('static', filename='qrcode.png') }}" alt="KHQR Code" />
    </div>
    <div class="khqr-subtle">Scan with your banking app to pay.</div>

    <!-- Status message -->
    <div id="payment-status" style="font-weight:600; margin:10px 0;">
      Waiting for payment...
    </div>
  </div>
  <div class="actions">
    <button id="paid" class="btn primary">I’ve Paid</button>
    <a class="btn" href="{{ url_for('products') }}">Continue to Shoping</a>
  </div>
</div>

<script>
  // countdown on the header
  let seconds = {{ seconds|int }};
  const timerEl = document.getElementById('timer');
  (function tick(){
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    timerEl.textContent = m + ":" + s;
    if (seconds > 0) { seconds--; setTimeout(tick, 1000); }
  })();

  const md5 = "{{ md5 }}";
  const POLL_MS = 3000;
  let pollId = null;

  function markSuccess() {
    // stop polling
    if (pollId) clearInterval(pollId);

    // hide the displayed QR
    const qr = document.getElementById('qr-section');
    if (qr) qr.style.display = 'none';

    // show green success message
    const st = document.getElementById('payment-status');
    st.style.color = 'green';
    st.style.fontSize = '1.1rem';
    st.textContent = '✅ Payment Success';

    // disable the "I’ve Paid" button
    const btn = document.getElementById('paid');
    if (btn) { btn.disabled = true; btn.style.opacity = .6; }
  }

  async function pollPaymentOnce() {
    try {
      const res = await fetch("{{ url_for('check_payment') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ md5 })
      });
      const data = await res.json();

      // Be robust to different server payloads
      const txnStatus = (data?.data?.transaction_status || data?.transaction_status || "").toUpperCase();
      const ok = (data?.success === true) || (txnStatus === "SUCCESS") || (data?.responseCode === 0);

      // Update status text if provided
      if (typeof data?.message === 'string' && data.message) {
        document.getElementById('payment-status').textContent = data.message;
      }

      if (ok) {
        markSuccess();
      }
    } catch (e) {
      // optional: show a subtle network hiccup
      // document.getElementById('payment-status').textContent = 'Rechecking...';
    }
  }

  // Start polling every 3s
  pollId = setInterval(pollPaymentOnce, POLL_MS);
  // Also allow a manual “I’ve Paid” click to trigger an immediate check
  document.getElementById('paid').addEventListener('click', pollPaymentOnce);

  {#AWS#}
</script>
    <script>
  const md5 = "{{ md5 }}";
  let stop = false;
  async function poll() {
    if (stop) return;
    try {
      const res = await fetch("/check-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ md5 }),
        credentials: "same-origin" // OK both local & prod; use "include" if cross-site
      });
      const data = await res.json();
      if (data.success) {
        stop = true;
        window.location = "/checkout/success";
      } else {
        setTimeout(poll, 3000);
      }
    } catch (e) {
      setTimeout(poll, 3000);
    }
  }
  poll();
</script>

{% endblock %}
